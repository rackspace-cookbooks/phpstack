<%- stackname = 'phpstack' -%>
#
# CHEF MANAGED FILE: DO NOT EDIT
# Generated by Chef for <%= node['hostname'] %>
# Controlling Cookbook: <%=  @cookbook_name %>
#
<%- unless @mysql.nil? -%>
<%-   @mysql[stackname][@mysql[stackname]['webserver']]['sites'].each do |port, sites| -%>
<%-     sites.each do |site_name, site_opts| -%>
<%-       next unless site_opts.key('databases') # this key is not created if db autocreation is disabled so we need to check-%>
<%-       site_opts['databases'].each do |database, database_opts| -%>
[MySQL-<%= database -%>]
master-host = <%= @mysql['mysql-multi']['master'] %>
slave-hosts = <%= @mysql['mysql-multi']['slaves'].join(', ') %>
port = <%= @mysql['mysql']['port'] %>
db_name = <%= database %>
username = <%= database_opts['mysql_user'] %>
password = <%= database_opts['mysql_password'] %>

<%-       end -%>
<%-     end -%>
<%-   end -%>
<%-   @mysql[stackname]['mysql']['databases'].each do |database, database_opts| -%>
[MySQL-<%= database -%>]
master-host = <%= @mysql['mysql-multi']['master'] %>
slave-hosts = <%= @mysql['mysql-multi']['slaves'].join(', ') %>
port = <%= @mysql['mysql']['port'] %>
db_name = <%= database %>
username = <%= database_opts['mysql_user'] %>
password = <%= database_opts['mysql_password'] %>

<%-   end -%>
<%- end -%>

<%- unless @rabbit.nil? -%>
<%-   @rabbit[stackname][@rabbit[stackname]['webserver']]['sites'].each do |port, sites| -%>
<%-     sites.each do |site_name, site_opts| -%>
<%-       rabbit_vhost = "#{site_name}-#{port}" -%>
[RabbitMQ-<%= rabbit_vhost -%>]
host = <%= @rabbit[stackname]['rabbitmq']['best_ip_for'] %>
port = <%= @rabbit['rabbitmq']['port'] %>
vhost = <%= rabbit_vhost %>
user = <%= rabbit_vhost %>
pass = <%= @rabbit[stackname]['rabbitmq']['passwords'][rabbit_vhost] %>

<%-     end -%>
<%-   end -%>
<%- end -%>
